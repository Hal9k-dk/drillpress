#!/usr/bin/env bash
##
echo 'Backup started'

##
pushd /srv/wordpress/www || exit

##
dbdump="wp-content/dbdump/$(date -u -Is).sql"
mkdir -p "$(dirname "$dbdump")"
chown www-data:www-data "$(dirname "$dbdump")"

##
echo Dumping wordpress-db to: "$dbdump"
docker run -it --rm \
  --user 33:33 \
  --volumes-from wordpress \
  --link wordpress-db wordpress:cli \
  wp db export "$dbdump"

##
echo "Compressing $dbdump"
bzip2 -9 "$dbdump"


##
echo 'Removing db dumps older than 5 days'
find "$(dirname "$dbdump")" -mtime +5 -delete -print

##
popd || exit

export B2_ACCOUNT_ID='{{ backblaze.keyID  }}'
export B2_ACCOUNT_KEY='{{ backblaze.applicationKey }}'
export RESTIC_PASSWORD='{{ restic.repopass }}'
export RESTIC_REPOSITORY='b2:drillpress-backup:restic'

##
if ! restic snapshots &>/dev/null; then
  echo 'Initialising restic repo'
  restic -q init
fi

##
echo 'Backing up dokuwiki and wordpress'
restic -q -v backup \
  /srv/dokuwiki \
  /srv/wordpress/www \
  /srv/wordpress/db-dumps

##
echo 'Backup done'
